{% extends "base.html" %}

{% block title %}{{ _('panels') }} - VPN Admin{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-server"></i> {{ _('panel_management') }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPanelModal">
            <i class="fas fa-plus me-1"></i> {{ _('add_panel') }}
        </button>
    </div>
</div>

<!-- Panels Grid -->
<div class="row">
    {% for panel in panels %}
    <div class="col-xl-4 col-lg-6 mb-4">
        <div class="card shadow h-100">
            <div class="card-header d-flex justify-content-between align-items-center py-3">
                <h6 class="m-0 font-weight-bold text-primary">{{ panel.name }}</h6>
                <div>
                    {% if panel.is_active %}
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i> Active
                        </span>
                    {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-pause-circle me-1"></i> Inactive
                        </span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-map-marker-alt text-muted me-2"></i>
                        <strong>{{ _('location') }}:</strong>
                        <span class="ms-2">{{ panel.location or 'Not specified' }}</span>
                    </div>
                    
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-link text-muted me-2"></i>
                        <strong>{{ _('url') }}:</strong>
                        <a href="{{ panel.url }}" target="_blank" class="ms-2 text-truncate" style="max-width: 200px;">
                            {{ panel.url }}
                        </a>
                    </div>
                    
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-users text-muted me-2"></i>
                        <strong>{{ _('clients') }}:</strong>
                        <span class="ms-2">{{ panel.current_clients }}/{{ panel.max_clients }}</span>
                    </div>
                    
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock text-muted me-2"></i>
                        <strong>{{ _('last_check') }}:</strong>
                        <span class="ms-2">
                            {% if panel.last_check %}
                                {{ panel.last_check.strftime('%d.%m.%Y %H:%M') }}
                            {% else %}
                                <span class="text-muted">{{ _('never') }}</span>
                            {% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="btn-group w-100" role="group">
                    <a href="{{ url_for('panel_detail', panel_id=panel.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-info-circle me-1"></i> {{ _('details') }}
                    </a>
                    <button class="btn btn-outline-{% if panel.is_active %}warning{% else %}success{% endif %} btn-sm"
                            onclick="togglePanel({{ panel.id }})">
                        <i class="fas fa-power-off me-1"></i> 
                        {% if panel.is_active %}{{ _('disable') }}{% else %}{{ _('enable') }}{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="card shadow text-center py-5">
            <div class="card-body">
                <i class="fas fa-server fa-4x text-muted mb-3"></i>
                <h4 class="text-muted">No Panels Configured</h4>
                <p class="text-muted mb-4">Add your first 3x-ui panel to get started</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPanelModal">
                    <i class="fas fa-plus me-2"></i> Add First Panel
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Panel Modal -->
<div class="modal fade" id="addPanelModal" tabindex="-1" aria-labelledby="addPanelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addPanelModalLabel">
                    <i class="fas fa-plus-circle me-2"></i> {{ _('add_panel_modal') }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i> {{ _('add_panel_instructions') }}</h6>
                    <p class="mb-2">Use the command in your server terminal:</p>
                    <code class="d-block p-2 bg-dark text-light rounded mb-2">
                        add_vpn_panel 'Name;URL;Username;Password;Location'
                    </code>
                    <p class="mb-0"><strong>{{ _('example') }}:</strong></p>
                    <code class="d-block p-2 bg-dark text-light rounded">
                        add_vpn_panel 'Germany #1;https://panel1.com:8080;admin;password123;Germany'
                    </code>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-check-circle text-success me-2"></i> Required Fields</h6>
                                <ul class="list-unstyled small">
                                    <li><strong>Name:</strong> Display name for the panel</li>
                                    <li><strong>URL:</strong> Full URL with port</li>
                                    <li><strong>Username:</strong> Admin username</li>
                                    <li><strong>Password:</strong> Admin password</li>
                                    <li><strong>Location:</strong> Server location</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6><i class="fas fa-shield-alt text-warning me-2"></i> Security Notes</h6>
                                <ul class="list-unstyled small">
                                    <li>Ensure panel URL is accessible</li>
                                    <li>Use secure credentials</li>
                                    <li>Verify panel connectivity</li>
                                    <li>Check API access permissions</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="https://github.com/your_username/vpn-bot-panel#readme" 
                   target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-book me-1"></i> Documentation
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function togglePanel(panelId) {
    if (!confirm('Are you sure you want to toggle this panel?')) {
        return;
    }
    
    fetch(`/api/panel/${panelId}/toggle`, { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error toggling panel: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error toggling panel:', error);
        alert('Error toggling panel');
    });
}

// Refresh panel status every minute
setInterval(() => {
    // You can add auto-refresh logic here if needed
}, 60000);
</script>

<style>
.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}
.btn-group .btn {
    border-radius: 6px;
}
</style>
{% endblock %}
